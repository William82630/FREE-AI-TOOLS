{% extends 'base.html' %}

{% block title %}Video to Audio Converter - Extract Audio from Video Online Free{% endblock %}
{% block description %}Convert video files to audio format online for free. Easy to use, no registration required, and secure conversion.{% endblock %}
{% block keywords %}video to audio, convert video to audio, video to audio converter, extract audio from video, free video to audio converter, online video to audio, video to audio online{% endblock %}

{% block hero_color %}#1565c0{% endblock %}
{% block hero_title %}Video to Audio Converter{% endblock %}
{% block hero_subtitle %}Extract audio from your video files. Free, secure, and no registration required.{% endblock %}

{% block button_gradient_start %}#1565c0{% endblock %}
{% block button_gradient_end %}#0d47a1{% endblock %}
{% block button_shadow_color %}rgba(21,101,192,0.3){% endblock %}
{% block button_shadow_hover_color %}rgba(21,101,192,0.4){% endblock %}

{% block step_title_color %}#ffffff{% endblock %}
{% block step_number_bg_color %}#1565c0{% endblock %}
{% block feature_title_color %}#ffffff{% endblock %}
{% block faq_title_color %}#ffffff{% endblock %}
{% block support_title_color %}#ffffff{% endblock %}

{% block additional_styles %}
.converter-container {
    background: #23263a;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    padding: 38px 32px 40px 32px;
    margin: 40px auto;
    max-width: 600px;
    border: 1px solid rgba(21,101,192,0.1);
    position: relative;
    overflow: hidden;
    text-align: center;
}
.converter-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #1565c0, #0d47a1);
}
.file-upload-container {
    position: relative;
    margin: 30px auto;
    max-width: 450px;
}
.file-upload-area {
    border: 2px dashed #1565c0;
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    background: #1a1d2e;
    transition: all 0.3s ease;
    cursor: pointer;
}
.file-upload-area:hover {
    border-color: #42a5f5;
    background: #1e2235;
}
.file-upload-area.dragover {
    border-color: #42a5f5;
    background: #1e2235;
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(21,101,192,0.4); }
    70% { box-shadow: 0 0 0 10px rgba(21,101,192,0); }
    100% { box-shadow: 0 0 0 0 rgba(21,101,192,0); }
}
.file-upload-icon {
    font-size: 48px;
    color: #1565c0;
    margin-bottom: 15px;
}
.file-upload-text {
    color: #e0e0e0;
    font-size: 1.1em;
    margin-bottom: 10px;
}
.file-upload-subtext {
    color: #9e9e9e;
    font-size: 0.9em;
}
.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}
.convert-button {
    background: linear-gradient(90deg, #1565c0 0%, #0d47a1 100%);
    color: white;
    padding: 16px 32px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2em;
    font-weight: bold;
    width: 100%;
    max-width: 300px;
    margin: 20px auto;
    display: block;
    box-shadow: 0 4px 12px rgba(21,101,192,0.15);
    transition: transform 0.2s, box-shadow 0.2s;
    opacity: 0.7;
    pointer-events: none;
}
.convert-button.active {
    opacity: 1;
    pointer-events: auto;
}
.convert-button.active:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(21,101,192,0.25);
}
.file-info {
    background: #1a1d2e;
    border-radius: 8px;
    padding: 15px;
    margin: 20px auto;
    max-width: 450px;
    display: none;
}
.file-info.show {
    display: block;
    animation: fadeIn 0.5s ease-out;
}
.file-name {
    color: #e0e0e0;
    font-size: 1.1em;
    word-break: break-all;
    margin-bottom: 5px;
}
.file-size {
    color: #9e9e9e;
    font-size: 0.9em;
}
.file-actions {
    margin-top: 10px;
}
.file-remove {
    background: none;
    border: none;
    color: #f44336;
    cursor: pointer;
    font-size: 0.9em;
    padding: 5px 10px;
    border-radius: 4px;
    transition: background 0.2s;
}
.file-remove:hover {
    background: rgba(244,67,54,0.1);
}
.progress-container {
    margin: 20px auto;
    max-width: 450px;
    display: none;
}
.progress-container.show {
    display: block;
    animation: fadeIn 0.5s ease-out;
}
.progress-bar-container {
    background: #1a1d2e;
    border-radius: 10px;
    height: 10px;
    overflow: hidden;
    margin-bottom: 10px;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #1565c0, #42a5f5);
    width: 0%;
    transition: width 0.3s ease;
}
.progress-text {
    color: #e0e0e0;
    font-size: 0.9em;
    text-align: center;
}
.result-container {
    margin: 20px auto;
    max-width: 450px;
    display: none;
}
.result-container.show {
    display: block;
    animation: fadeIn 0.5s ease-out;
}
.result-success {
    background: #1a1d2e;
    border-radius: 8px;
    padding: 20px;
    border-left: 4px solid #4caf50;
}
.result-error {
    background: #1a1d2e;
    border-radius: 8px;
    padding: 20px;
    border-left: 4px solid #f44336;
}
.result-title {
    color: #e0e0e0;
    font-size: 1.1em;
    margin-bottom: 10px;
}
.result-message {
    color: #9e9e9e;
    font-size: 0.9em;
    margin-bottom: 15px;
    white-space: pre-line;
}
.download-button {
    background: linear-gradient(90deg, #43a047 0%, #2e7d32 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: bold;
    display: inline-block;
    box-shadow: 0 4px 12px rgba(67,160,71,0.15);
    transition: transform 0.2s, box-shadow 0.2s;
}
.download-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(67,160,71,0.25);
}
.try-again-button {
    background: none;
    border: 1px solid #e0e0e0;
    color: #e0e0e0;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    margin-top: 15px;
    transition: background 0.2s;
}
.try-again-button:hover {
    background: rgba(255,255,255,0.1);
}
.options-container {
    margin: 20px auto;
    max-width: 450px;
    background: #1a1d2e;
    border-radius: 8px;
    padding: 15px;
    text-align: left;
}
.option-group {
    margin-bottom: 15px;
}
.option-group:last-child {
    margin-bottom: 0;
}
.option-label {
    display: block;
    color: #e0e0e0;
    font-size: 0.9em;
    margin-bottom: 5px;
}
.option-select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #2c2f45;
    background: #23263a;
    color: #e0e0e0;
    font-size: 0.9em;
}
.option-select:focus {
    outline: none;
    border-color: #1565c0;
}
.refresh-button {
    background: #1a1d2e;
    border: 1px solid #2c2f45;
    color: #e0e0e0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
    margin-left: 15px;
}
.refresh-button:hover {
    background: #2c2f45;
    transform: rotate(15deg);
}
.refresh-button svg {
    transition: transform 0.3s ease;
}
.refresh-button:hover svg {
    transform: rotate(45deg);
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
{% endblock %}

{% block content %}
<div class="converter-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="color: #ffffff; margin-top: 0; text-align: left;">Convert Video to Audio</h2>
            <p style="color: #e0e0e0; margin-bottom: 0; text-align: left;">Extract audio from your video files with our free online converter</p>
        </div>
        <button id="refresh-button" class="refresh-button" title="Start Over">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M3 21v-5h5"></path>
            </svg>
        </button>
    </div>

    <form id="upload-form" enctype="multipart/form-data">
        <div class="file-upload-container">
            <div class="file-upload-area" id="drop-area">
                <div class="file-upload-icon">üé¨</div>
                <div class="file-upload-text">Drag & drop your video file here</div>
                <div class="file-upload-subtext">or click to browse files</div>
                <input type="file" id="file-input" name="file" class="file-input" accept="video/*">
            </div>
        </div>

        <div class="file-info" id="file-info">
            <div class="file-name" id="file-name"></div>
            <div class="file-size" id="file-size"></div>
            <div class="file-actions">
                <button type="button" class="file-remove" id="file-remove">Remove</button>
            </div>
        </div>

        <div class="options-container">
            <div class="option-group">
                <label class="option-label" for="audio-quality">Audio Quality:</label>
                <select class="option-select" id="audio-quality">
                    <option value="high" selected>High Quality (320 kbps)</option>
                    <option value="medium">Medium Quality (192 kbps)</option>
                    <option value="low">Low Quality (128 kbps)</option>
                </select>
            </div>
        </div>

        <button type="button" id="convert-button" class="convert-button">Extract Audio</button>
    </form>

    <div class="progress-container" id="progress-container">
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">Converting... 0%</div>
    </div>

    <div class="result-container" id="result-success">
        <div class="result-success">
            <div class="result-title">Conversion Successful!</div>
            <div class="result-message" id="success-message">Your MP4 file has been successfully converted to audio format.</div>
            <button class="download-button" id="download-button">Download Audio</button>
        </div>
    </div>

    <div class="result-container" id="result-error">
        <div class="result-error">
            <div class="result-title">Conversion Failed</div>
            <div class="result-message" id="error-message">There was an error converting your file. Please try again.</div>
            <button class="try-again-button" id="try-again-button">Try Again</button>
        </div>
    </div>
</div>

<div class="how-it-works">
    <h2>How to Use Our Video to Audio Converter</h2>
    <div class="how-to-steps">
        <div class="step">
            <h3><span>1</span>Upload Your Video File</h3>
            <p>Click the upload area or drag and drop your video file into the designated box. Our tool accepts video files up to 1GB in size. The upload process is quick and secure, with no registration required.</p>
        </div>
        <div class="step">
            <h3><span>2</span>Choose Audio Quality</h3>
            <p>Select your preferred audio quality for the output audio file. Higher quality provides better sound but results in larger file sizes, while lower quality creates smaller files that are ideal for mobile devices or when storage space is limited.</p>
        </div>
        <div class="step">
            <h3><span>3</span>Start Extraction</h3>
            <p>Click the "Extract Audio" button to begin the process. Our advanced browser-based technology will extract the audio track from your video file, removing all video content while preserving the audio quality according to your selected settings.</p>
        </div>
        <div class="step">
            <h3><span>4</span>Download Your Audio File</h3>
            <p>After extraction is complete, you can preview the audio and then click the "Download Audio" button to save your file. The audio file is ready for playback on any device, including smartphones, tablets, and computers. The entire process happens in your browser - no files are uploaded to any server.</p>
        </div>
    </div>
</div>

<div class="features">
    <h2>Features of Our MP4 to MP3 Converter</h2>
    <div class="feature-cards">
        <div class="feature-card">
            <h3>üîí 100% Private Conversion</h3>
            <p>Your MP4 files are processed entirely in your browser - they never leave your device! This browser-based conversion ensures maximum privacy and security, as no files are uploaded to any server.</p>
        </div>
        <div class="feature-card">
            <h3>‚ö° Fast Processing</h3>
            <p>Our optimized conversion engine processes your video files quickly, typically completing extractions in seconds. Save time with our efficient service that doesn't compromise on audio quality.</p>
        </div>
        <div class="feature-card">
            <h3>üì± No Installation Required</h3>
            <p>Access our converter directly from your web browser without downloading or installing any software. Works on all platforms including Windows, Mac, Linux, iOS, and Android.</p>
        </div>
        <div class="feature-card">
            <h3>üîç Quality Options</h3>
            <p>Choose from multiple audio quality settings to balance file size and sound quality. High quality (320 kbps) provides premium sound, while lower settings create smaller files that are perfect for mobile devices.</p>
        </div>
        <div class="feature-card">
            <h3>üéß Audio Preservation</h3>
            <p>Our converter maintains the original audio characteristics from your video, including stereo channels, sample rate, and audio clarity. The extracted MP3 preserves the full audio experience of your original video.</p>
        </div>
        <div class="feature-card">
            <h3>üí∏ Completely Free</h3>
            <p>Enjoy unlimited MP4 to MP3 conversions without any cost. No hidden fees, no subscriptions, and no watermarks‚Äîjust a reliable, free service for all your video-to-audio conversion needs.</p>
        </div>
    </div>
</div>

<div class="faq">
    <h2>Frequently Asked Questions</h2>
    <div class="faq-item">
        <h3>Why would I need to convert MP4 to MP3?</h3>
        <p>Converting MP4 to MP3 is useful when you want to extract audio from videos for listening on the go, creating music playlists from video content, reducing file size for storage, using audio clips in presentations or podcasts, or when you only need the audio portion of a video file.</p>
    </div>
    <div class="faq-item">
        <h3>What happens to the video content during conversion?</h3>
        <p>During the MP4 to MP3 conversion process, the video content (visual elements) is removed, and only the audio track is preserved. This significantly reduces the file size while maintaining the original audio quality based on your selected settings.</p>
    </div>
    <div class="faq-item">
        <h3>Is there a file size limit for conversion?</h3>
        <p>Yes, our free converter has a file size limit of 1GB per MP4 file. This generous limit accommodates most standard videos, including music videos, movies, presentations, and longer recordings. For extremely large files over 1GB, consider trimming your video into smaller segments before uploading.</p>
    </div>
    <div class="faq-item">
        <h3>How secure is my data during the conversion process?</h3>
        <p>Our converter offers maximum security because your files never leave your device! The entire conversion process happens directly in your browser using advanced web technology. Your MP4 files are never uploaded to any server, ensuring complete privacy and confidentiality.</p>
    </div>
    <div class="faq-item">
        <h3>Which audio quality should I choose?</h3>
        <p>The choice depends on your needs. High quality (320 kbps) provides the best sound experience but creates larger files. Medium quality (192 kbps) offers a good balance between quality and file size. Low quality (128 kbps) creates the smallest files, suitable for mobile devices or when storage space is limited.</p>
    </div>
    <div class="faq-item">
        <h3>Can I convert other video formats to MP3?</h3>
        <p>Currently, our tool is optimized for MP4 to MP3 conversion. For other video formats like AVI, MOV, or WMV, you may need to first convert them to MP4 format using our other conversion tools, then use this tool to extract the audio as MP3.</p>
    </div>
</div>
{% endblock %}

{% block twitter_path %}/tools/free-online-converter/mp4-to-mp3{% endblock %}
{% block twitter_text %}Extract+audio+from+videos+for+free+with+this+online+tool!{% endblock %}
{% block facebook_path %}/tools/free-online-converter/mp4-to-mp3{% endblock %}
{% block linkedin_path %}/tools/free-online-converter/mp4-to-mp3{% endblock %}
{% block linkedin_title %}Free+Online+MP4+to+MP3+Converter{% endblock %}
{% block linkedin_summary %}Extract+audio+from+your+videos+easily+and+for+free{% endblock %}
{% block pinterest_path %}/tools/free-online-converter/mp4-to-mp3{% endblock %}
{% block pinterest_description %}MP4+to+MP3+Converter+-+Extract+audio+from+videos+online+free{% endblock %}
{% block whatsapp_text %}Check+out+this+free+MP4+to+MP3+Converter:+http://127.0.0.1:5000/tools/free-online-converter/mp4-to-mp3{% endblock %}

{% block body_scripts %}
<script>
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const fileRemove = document.getElementById('file-remove');
    const convertButton = document.getElementById('convert-button');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const resultSuccess = document.getElementById('result-success');
    const resultError = document.getElementById('result-error');
    const downloadButton = document.getElementById('download-button');
    const tryAgainButton = document.getElementById('try-again-button');
    const refreshButton = document.getElementById('refresh-button');
    const errorMessage = document.getElementById('error-message');

    let selectedFile = null;

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false);

    // Handle selected files from file input
    fileInput.addEventListener('change', handleFiles);

    // Handle convert button
    convertButton.addEventListener('click', startConversion);

    // Handle try again button
    tryAgainButton.addEventListener('click', resetConverter);

    // Handle download button
    downloadButton.addEventListener('click', downloadResult);

    // Handle file remove button
    fileRemove.addEventListener('click', removeFile);

    // Handle refresh button
    refreshButton.addEventListener('click', function() {
        // Reset everything
        selectedFile = null;
        fileInput.value = '';
        fileInfo.style.display = 'none';
        fileInfo.classList.remove('show');
        progressContainer.classList.remove('show');
        resultSuccess.classList.remove('show');
        resultError.classList.remove('show');

        // Show convert button and options again
        convertButton.style.display = 'block';
        document.querySelector('.options-container').style.display = 'block';
        convertButton.classList.remove('active');

        // Force page reload to ensure complete reset
        window.location.reload();
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight() {
        dropArea.classList.add('dragover');
    }

    function unhighlight() {
        dropArea.classList.remove('dragover');
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files } });
    }

    function handleFiles(e) {
        const files = e.target.files;
        if (files.length) {
            const file = files[0];

            // Check if file is an MP4
            if (!file.type.includes('video/mp4') && !file.name.toLowerCase().endsWith('.mp4')) {
                showError('Please select a valid MP4 file.');
                return;
            }

            // Check file size (max 1GB)
            if (file.size > 1024 * 1024 * 1024) {
                showError('File size exceeds the 1GB limit. Please select a smaller file.');
                return;
            }

            // Store the selected file
            selectedFile = file;

            // Update file info display
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');

            // Enable convert button
            convertButton.classList.add('active');
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';

        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function removeFile() {
        selectedFile = null;
        fileInput.value = '';
        fileInfo.classList.remove('show');
        fileInfo.style.display = 'none';
        convertButton.classList.remove('active');

        // Log to confirm function is called
        console.log("Remove file function called");
    }

    // Browser-based conversion using Web Audio API
    async function startConversion() {
        if (!selectedFile) return;

        // Hide file info and convert button
        fileInfo.style.display = 'none';
        convertButton.style.display = 'none';
        document.querySelector('.options-container').style.display = 'none';

        // Show progress
        progressContainer.classList.add('show');
        progressBar.style.width = '0%';

        // Get options
        const audioQuality = document.getElementById('audio-quality').value;

        // Update progress text
        progressText.textContent = `Extracting audio... 0%`;

        try {
            // Create a URL for the video file
            const videoURL = URL.createObjectURL(selectedFile);

            // Create a video element to extract audio
            const video = document.createElement('video');
            video.style.display = 'none';
            document.body.appendChild(video);

            // Set up progress tracking
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 1;
                if (progress > 95) progress = 95; // Cap at 95% until actual completion
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `Extracting audio... ${progress}%`;
            }, 200);

            // Load the video
            video.src = videoURL;

            // Wait for metadata to load
            await new Promise(resolve => {
                video.onloadedmetadata = resolve;
            });

            // Check if MediaRecorder is supported
            if (typeof MediaRecorder === 'undefined') {
                throw new Error("Your browser doesn't support audio extraction. Please try a different browser like Chrome, Firefox, or Edge.");
            }

            // Use a simpler approach - get the audio directly from the video element
            // This is more reliable across browsers

            // Create a simple audio capture from the video element
            video.muted = false; // Make sure video is not muted

            // Create a MediaStream from the video's audio track
            let captureStream;

            // Different browsers have different methods to capture media
            if (video.captureStream) {
                captureStream = video.captureStream();
            } else if (video.mozCaptureStream) {
                captureStream = video.mozCaptureStream();
            } else {
                // Fallback for browsers that don't support direct capture
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaElementSource(video);
                const destination = audioContext.createMediaStreamDestination();
                source.connect(destination);
                captureStream = destination.stream;
            }

            // Create a MediaRecorder with the captured stream
            const mediaRecorder = new MediaRecorder(captureStream);

            // Set up data collection
            const audioChunks = [];

            // Handle data available events
            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);

                    // Update progress based on current time vs duration
                    if (video.duration) {
                        const currentProgress = Math.min(95, Math.floor((video.currentTime / video.duration) * 95));
                        progressBar.style.width = `${currentProgress}%`;
                        progressText.textContent = `Extracting audio... ${currentProgress}%`;
                    }
                }
            };

            // First, play the video with audio
            try {
                // Make sure video is NOT muted so we can capture the audio
                video.muted = false;
                video.volume = 0.5; // Set volume to 50%

                // Add audio controls for debugging (hidden from view)
                video.controls = true;
                video.style.position = 'fixed';
                video.style.top = '-9999px';
                video.style.left = '-9999px';

                // Try to play the video
                await video.play();
                console.log("Video playback started with audio");
            } catch (playError) {
                console.error("Error playing video:", playError);

                // If autoplay with sound fails (common in many browsers), try with muted
                try {
                    console.log("Trying muted playback");
                    video.muted = true;
                    await video.play();

                    // After playback starts, unmute (this often works)
                    setTimeout(() => {
                        video.muted = false;
                        video.volume = 0.5;
                    }, 1000);

                    console.log("Video playback started muted, then unmuted");
                } catch (mutedPlayError) {
                    console.error("Error playing muted video:", mutedPlayError);
                    throw new Error("Could not play the video. Please try a different file or browser.");
                }
            }

            // Then start recording after video is playing
            try {
                console.log("Starting MediaRecorder");
                mediaRecorder.start(1000); // Get data every second
                console.log("MediaRecorder state:", mediaRecorder.state);
            } catch (recorderError) {
                console.error("Error starting MediaRecorder:", recorderError);
                throw new Error("Failed to start audio extraction. Please try a different file or browser.");
            }

            // Set a reasonable processing time based on video duration
            const processingTime = Math.min(
                (video.duration * 1000) + 3000, // Video duration + 3 second buffer
                60 * 1000 // Maximum 1 minute for very long videos
            );

            // Force completion after a short time to prevent getting stuck
            setTimeout(() => {
                // Update progress to 100%
                progressBar.style.width = '100%';
                progressText.textContent = `Extraction complete! 100%`;

                // Stop recording if still going
                if (mediaRecorder.state === 'recording') {
                    console.log("Forcing MediaRecorder to stop");
                    mediaRecorder.stop();
                }
            }, processingTime);

            // Set a shorter timeout for the initial recording
            // This ensures we get at least some audio data
            setTimeout(() => {
                if (mediaRecorder.state === 'recording') {
                    // Request data so far
                    mediaRecorder.requestData();
                }
            }, 3000); // Get data after 3 seconds

            // Wait for the video to finish or timeout
            await new Promise((resolve) => {
                // When video ends naturally
                video.onended = () => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                    resolve();
                };

                // If processing takes too long, resolve anyway
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                    resolve();
                }, processingTime);
            });

            // Wait for the last data to be available
            await new Promise(resolve => {
                mediaRecorder.onstop = resolve;
            });

            // Clear the progress interval
            clearInterval(progressInterval);

            // Create a blob from the audio chunks - always use WebM for reliability
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

            // Create a URL for the blob
            const audioURL = URL.createObjectURL(audioBlob);

            // Clean up
            URL.revokeObjectURL(videoURL);
            document.body.removeChild(video);

            // Update UI
            progressBar.style.width = '100%';
            progressText.textContent = `Extraction complete! 100%`;

            // Create an audio element to test the extracted audio
            const audioElement = document.createElement('audio');
            audioElement.controls = true;
            audioElement.style.width = '100%';
            audioElement.style.marginTop = '20px';
            audioElement.src = audioURL;

            setTimeout(() => {
                progressContainer.classList.remove('show');
                resultSuccess.classList.add('show');

                // Update success message
                const successMessage = `Your video file has been successfully processed. The audio has been extracted entirely in your browser - no files were uploaded to any server.`;
                document.getElementById('success-message').textContent = successMessage;

                // Add audio player to preview the result
                const previewContainer = document.createElement('div');
                previewContainer.className = 'preview-container';
                previewContainer.style.marginTop = '20px';
                previewContainer.style.marginBottom = '20px';

                const previewLabel = document.createElement('p');
                previewLabel.textContent = 'Preview:';
                previewLabel.style.marginBottom = '10px';

                previewContainer.appendChild(previewLabel);
                previewContainer.appendChild(audioElement);

                // Insert the preview before the download button
                const downloadButtonContainer = document.getElementById('download-button').parentNode;
                downloadButtonContainer.parentNode.insertBefore(previewContainer, downloadButtonContainer);

                // Update download button
                document.getElementById('download-button').textContent = `Download Audio`;

                // Set download URL and filename
                downloadButton.setAttribute('data-url', audioURL);
                downloadButton.setAttribute('data-filename', `audio_${selectedFile.name.replace(/\.[^/.]+$/, '')}.webm`);
            }, 500);

        } catch (error) {
            console.error('Conversion error:', error);
            progressContainer.classList.remove('show');
            showError(`Extraction error: ${error.message || 'Unknown error'}`);
        }
    }

    // Helper function to read file as ArrayBuffer
    function readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsArrayBuffer(file);
        });
    }

    function showError(message) {
        resultError.classList.add('show');
        errorMessage.textContent = message;
    }

    function resetConverter() {
        // Reset everything
        selectedFile = null;
        fileInput.value = '';
        fileInfo.style.display = 'block';
        fileInfo.classList.remove('show');
        progressContainer.classList.remove('show');
        resultSuccess.classList.remove('show');
        resultError.classList.remove('show');

        // Show convert button and options again
        convertButton.style.display = 'block';
        document.querySelector('.options-container').style.display = 'block';
        convertButton.classList.remove('active');
    }

    function downloadResult() {
        const url = downloadButton.getAttribute('data-url');
        const filename = downloadButton.getAttribute('data-filename');

        if (url) {
            // Create a temporary link element
            const a = document.createElement('a');
            a.href = url;
            a.download = filename || 'audio_extract.webm';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Log download
            console.log('Audio downloaded:', filename);
        }
    }
</script>
{% endblock %}